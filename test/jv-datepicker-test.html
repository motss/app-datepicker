<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">

    <link rel="import" href="../jv-datepicker.html">
  </head>
  <body>

    <!-- Setting up test-fixture for jv-datepicker -->
    <test-fixture id="JvDatepicker">
      <template>
        <jv-datepicker></jv-datepicker>
      </template>
    </test-fixture>

    <script>
      'use strict';
      describe('<jv-datepicker>', function () {
        var datepicker;
        beforeEach(function () {
          datepicker = fixture('JvDatepicker');
        });

        context('datepicker has role="datepicker"', function () {
          it('should show "datepicker" for attribute role', function () {
            expect(datepicker.getAttribute('role')).to.be.equal('datepicker');
          });
        });

        context('test inputs for correct selected view', function() {
          it('should select date view on start', function () {
            var _ironSelector = datepicker.querySelector('iron-selector');
            expect(_ironSelector.selected).to.be.equal('calendar');
          });

          it('should select the correct view (year)', function () {
            var _yearView = datepicker.querySelector('iron-selector .selected-year');
            _yearView.dispatchEvent(new CustomEvent('tap', {bubbles: true}));
            expect(_yearView.classList.contains('iron-selected'));
          });

          it('should select the correct view (date)', function () {
            var _ironSelector = datepicker.querySelector('iron-selector'),
                _dateView = _ironSelector.querySelector('div.selected-date'),
                _yearView = _ironSelector.querySelector('div.selected-year');
            _yearView.dispatchEvent(new CustomEvent('tap', {bubbles: true}));
            _dateView.dispatchEvent(new CustomEvent('tap', {bubbles: true}));
            expect(_dateView.classList.contains('iron-selected')).to.be.true;
          });

          it('should show correct locale based on the system', function() {
            var _systemLocale = window.navigator.language;
            expect(datepicker.locale).to.be.equal(_systemLocale);
          });
        });

        context('test for update to reflect external date change', function() {
          // All possibilityes = 2 * 4 * 3 = 24.
          // 'yyyy' 'mmmm' 'do' - N
          // 'yyyy' 'mmmm' 'dd' - P
          // 'yyyy' 'mmmm' 'd' - P
          //
          // 'yyyy' 'mmm' 'do' - N
          // 'yyyy' 'mmm' 'dd' - P
          // 'yyyy' 'mmm' 'd' - P
          //
          // 'yyyy' 'mm' 'do' - N
          // 'yyyy' 'mm' 'dd' - P
          // 'yyyy' 'mm' 'd' - P
          //
          // 'yyyy' 'm' 'do' - N
          // 'yyyy' 'm' 'dd' - P
          // 'yyyy' 'm' 'd' - P
          //
          // 'yy' 'mmmm' 'do' - N
          // 'yy' 'mmmm' 'dd' - P
          // 'yy' 'mmmm' 'd' - P
          //
          // 'yy' 'mmm' 'do' - N
          // 'yy' 'mmm' 'dd' - P
          // 'yy' 'mmm' 'd' - P
          //
          // 'yy' 'mm' 'do' - N
          // 'yy' 'mm' 'dd' - F*
          // 'yy' 'mm' 'd' - F*
          //
          // 'yy' 'm' 'do' - N
          // 'yy' 'm' 'dd' - F*
          // 'yy' 'm' 'd' - F*
          it('should show correct output date when showLongDate is falsy', function() {
            // var _allPossibilities = [
            //   '2016 January 31st', '2016 January 31', '2016 January 3',
            //   '2016 Jan 31st', '2016 Jan 31', '2016 Jan 3',
            //   '2016 01 31st', '2016 01 31', '2016 01 3',
            //   '2016 1 31st', '2016 1 31', '2016 1 3',
            //   '16 January 31st', '16 January 31', '16 January 3',
            //   '16 Jan 31st', '16 Jan 31', '16 Jan 3',
            //   '16 01 31st', '16 01 31', '16 01 3',
            //   '16 1 31st', '16 1 31', '16 1 3'
            // ];
            // accepted input date string:
            // 1. 2016 January 31
            // 2. 2016 January 3
            // 3. 2016 Jan 31
            // 4. 2016 Jan 3
            // 5. 2016/13/13
            var _acceptedInputDateStrings = [
              '2016 January 31', '2016 January 3', '2016 Jan 31', '2016 Jan 3', '2015/13/31'
            ];
            var _testDate = new Date(2016, 0, 31);
            var _testDate2 = new Date(2016, 0, 3);

            datepicker.showLongDate = !1;
            for (var i = 0, len = _acceptedInputDateStrings.length; i < len; i++) {
              datepicker.inputDate = _acceptedInputDateStrings[i];
              datepicker.enforceDateChange();

              var _getDate = [
                _testDate2.getFullYear(),
                ('0' + (_testDate2.getMonth() + 1)).slice(-2),
                ('0' + _testDate2.getDate()).slice(-2)
              ].join('/');
              if (i === 0 || i === 2 || i === 4) {
                _getDate = [
                  _testDate.getFullYear(),
                  ('0' + (_testDate.getMonth() + 1)).slice(-2),
                  ('0' + _testDate.getDate()).slice(-2)
                ].join('/');
                expect(datepicker.date).to.be.equal(_getDate);
              }else {
                expect(datepicker.date).to.be.equal(_getDate);
              }
            }
          });

          it('should show correct output date when showLongDate is truthy', function() {
            var _acceptedInputDateStrings = [
              '2016 January 31', '2016 January 3', '2016 Jan 31', '2016 Jan 3', '2015/13/31',
              'Fri, May 25, 2020'
            ];
            var _testDate = 'Sun, Jan 31, 2016';
            var _testDate2 = 'Sun, Jan 3, 2016';

            datepicker.showLongDate = !0;
            datepicker.locale = 'en';

            for (var i = 0, len = _acceptedInputDateStrings.length; i < len; i++) {
              datepicker.inputDate = _acceptedInputDateStrings[i];
              datepicker.enforceDateChange();

              if (i === 0 || i === 2 || i === 4) {
                expect(datepicker.date).to.be.not.equal(_testDate);
              }else if (i == 5) {
                if (window.navigator.msManipulationViewsEnabled) {
                  expect(datepicker.date).to.be.equal('Mon, May, 25, 2020');
                }else {
                  // wrong weekday from input date but the datepicker wil correct that
                  // as long as the date is a valid input.
                  expect(datepicker.date).to.be.equal('Mon, May 25, 2020');
                }
              }else {
                expect(datepicker.date).to.be.not.equal(_testDate2);
              }
            }
          });

          it('should display correct output date when locale is changed', function() {
            datepicker.showLongDate = !0;
            datepicker.inputDate = 'Sun, Jan 31, 2016';
            datepicker.enforceDateChange();
            datepicker.locale = 'fr-FR';

            // IE11 broke it again.
            var _toSplit = datepicker.date.split(' ');
            var _temp = [];
            for (var i = 0, len = _toSplit.length; i < len; i++) {
              _temp[i] = encodeURIComponent(_toSplit[i]).replace(/\%[0-9A-Z]{2}/gi, '');
            }
            expect(_temp.join(' ')).to.be.equal('dim. 31 janv. 2016');
          });
        });
      });
    </script>

  </body>
</html>
